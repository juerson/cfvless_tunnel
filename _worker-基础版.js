import{connect as W}from"cloudflare:sockets";function I(e){if("string"!=typeof e)throw new TypeError("sha224Encrypt: input must be a string");let t=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function r(e,t){return e>>>t|e<<32-t}let a=(new TextEncoder).encode(e),n=8*a.length,o=a.length+9+63>>6<<6,s=new Uint8Array(o);s.set(a),s[a.length]=128,new DataView(s.buffer).setUint32(s.length-4,n,!1);let i=new Uint32Array(64),l=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428].slice();for(let e=0;e<s.length;e+=64){let a=new DataView(s.buffer,e,64);for(let e=0;e<16;e++)i[e]=a.getUint32(4*e);for(let e=16;e<64;e++){let t=r(i[e-15],7)^r(i[e-15],18)^i[e-15]>>>3,a=r(i[e-2],17)^r(i[e-2],19)^i[e-2]>>>10;i[e]=i[e-16]+t+i[e-7]+a>>>0}let[n,o,c,d,u,f,p,w]=l;for(let e=0;e<64;e++){let a=w+(r(u,6)^r(u,11)^r(u,25))+(u&f^~u&p)+t[e]+i[e]>>>0,s=(r(n,2)^r(n,13)^r(n,22))+(n&o^n&c^o&c)>>>0;[w,p,f,u,d,c,o,n]=[p,f,u,d+a>>>0,c,o,n,a+s>>>0]}l[0]=l[0]+n>>>0,l[1]=l[1]+o>>>0,l[2]=l[2]+c>>>0,l[3]=l[3]+d>>>0,l[4]=l[4]+u>>>0,l[5]=l[5]+f>>>0,l[6]=l[6]+p>>>0,l[7]=l[7]+w>>>0}return l.slice(0,7).map(e=>e.toString(16).padStart(8,"0")).join("")}function P(e){let t,r,a=e=>(e=+e)>=1&&e<=65535?e:443,n=443;if("["===e[0]){if(-1===(r=e.indexOf("]")))return{hostname:null,port:null};t=e.slice(0,r+1),":"===e[r+1]&&(n=a(e.slice(r+2)))}else-1!==(r=e.lastIndexOf(":"))&&e.indexOf(":")===r?(t=e.slice(0,r),n=a(e.slice(r+1))):t=e;return{hostname:t,port:n}}function R(e){let t,r,a,n,[o,s]=e.split("@").reverse();if(s){let e=s.split(":");if(2!==e.length)throw new Error("Invalid SOCKS address format");[t,r]=e}let i=o.split(":");if(n=Number(i.pop()),isNaN(n))throw new Error("Invalid SOCKS address format");a=i.join(":");if(a.includes(":")&&!/^\[.*\]$/.test(a))throw new Error("Invalid SOCKS address format");return{username:t,password:r,hostname:a,port:n}}var E="61098bdc-b734-4874-9e87-d18b1ef1cfaf",N="b379f280b9a4ce21e465cb31eea09a8fe3f4f8dd1850d9f630737538",v=!1,B="",_="",D=`${["2001","67c","2960","6464"].join(":")}::`,L=["https://www.bilibili.com","https://www.nicovideo.jp","https://tv.naver.com","https://www.hotstar.com","https://www.netflix.com","https://www.dailymotion.com","https://www.youtube.com","https://www.hulu.com","https://fmovies.llc","https://hdtodayz.to","https://radar.cloudflare.com"],H={hostname:null,port:443},$={},k=!1,ce={async fetch(e,t,r){try{E=t.UUID4||E,N=I(t.USERPWD||E),v=["1","true","yes","on"].includes((t.ENABLED_S5||"").toLowerCase())||v;let r=t.LANDING_ADDRESS||B,a=t.SOCKS5||_;D=t.NAT64||D;let n=e.headers.get("Upgrade"),o=new URL(e.url).pathname;if(n&&"websocket"===n){if($={},k=!1,o.includes("/pyip=")?(r=o.split("/pyip=")[1],k=!1):o.includes("/socks=")&&(a=o.split("/socks=")[1],k=!0),a)$=R(a);else if(r){let e="";if(r.includes(",")){let t=r.split(",");e=t[Math.floor(Math.random()*t.length)].trim()}else e=r.trim();H=P(e)}return await F(e)}if("/"===o){let e=L[Math.floor(Math.random()*L.length)];return new Response(null,{status:301,headers:{Location:e}})}return new Response("404 Not Found!",{status:404})}catch(e){return new Response(e.toString())}}};async function F(e){let[t,r]=Object.values(new WebSocketPair);r.accept();let a="",n="",o=(e,t)=>{console.log(`[${a}:${n}] ${e}`,t||"")},s=new AbortController,{resetIdleTimer:i,controller:l}=q({webSocket:r,signal:s.signal,idleTimeoutMs:2e4,maxLifetimeMs:18e4,onAbort:e=>{o?.("ðŸ³ disconnecting reason:",e),A(r)}}),c=e.headers.get("sec-websocket-protocol")||"",d=z(r,c,o),u=null,f={value:null},p=V({webSocket:r,remoteSocketWrapper:f,timeoutMs:5e3,log:o});try{d.pipeTo(new WritableStream({async write(e,t){if(i(),f.value){let t=f.value.writable.getWriter();return await t.write(e),void t.releaseLock()}let s=re(e),l={...v?{0:[J,[e]]}:{},1:[G,[e,E]],2:[K,[e,N]]}[s];if(!l)return o(`Unsupported protocol mapCode: ${s}`);let[c,d]=l,w=c(...d);if(!w||w?.hasError)return t.error(`Header parse error: ${w?.message}`);if(p(),!w?.isUDP||53==w?.portRemote){if(w?.isUDP){let{write:e}=await te(r,w?.responseHeader,o);return u=e,void u(w?.rawClientData)}a=w?.addressRemote,n=`${w?.portRemote}--${Math.random()} ${w?.isUDP?"udp ":"tcp "}`,Q(f,w,r,o)}},close(){o("webSocketReadableStream is close")},abort(e){o("webSocketReadableStream is abort",JSON.stringify(e))}}),{signal:l.signal}).catch(e=>{o("webSocketReadableStream pipeTo error",e)})}catch(e){"AbortError"===e.name?o("Stream aborted by AbortController, usually due to a timeout or explicit cancellation:",e):o("Unexpected pipeTo error:",e)}return new Response(null,{status:101,webSocket:t})}function V({webSocket:e,remoteSocketWrapper:t,timeoutMs:r=5e3,log:a}){let n=setTimeout(()=>{if(!t.value){a("ðŸ¤ Handshake timeout: no protocol header received, closing WebSocket");try{e.readyState===WebSocket.OPEN&&e.close(1008,"Handshake timeout")}catch(e){a("Failed to close WebSocket after timeout",e)}}},r);return()=>clearTimeout(n)}function q({webSocket:e,signal:t,onAbort:r,idleTimeoutMs:a=3e4,maxLifetimeMs:n=18e4}){let o=null,s=null,i=new AbortController,l=!1,c=()=>{clearTimeout(o),clearTimeout(s),t&&f&&t.removeEventListener("abort",f)},d=t=>{l||(l=!0,console.warn("idle"===t?`â³ Idle for over ${a/1e3}s, disconnecting.`:`ðŸ›‘ Max lifetime of ${n/1e3}s reached, disconnecting.`),A(e),i.abort(),r?.(t),c())},u=()=>{clearTimeout(o),!l&&(o=setTimeout(()=>d("idle"),a))},f=()=>{d("external")};return u(),s=setTimeout(()=>d("lifetime"),n),t?.addEventListener("abort",f),{controller:i,resetIdleTimer:u,cleanup:c}}function z(e,t,r){let a=!1;return new ReadableStream({start(n){e.addEventListener("message",e=>{a||n.enqueue(e.data)}),e.addEventListener("close",()=>{a||n.close(),A(e)}),e.addEventListener("error",e=>{r("WebSocket error"),n.error(`ReadableStream error: ${e.message}`)});let{earlyData:o,error:s}=ee(t);s?n.error(`Base64 decode error: ${s.message}`):o&&n.enqueue(o)},cancel(t){a||(a=!0,r(`ReadableStream canceled: ${t}`),A(e))}})}function G(e,t){let r=new Uint8Array(e);if(r.length<24)return{hasError:!0,message:"Too short"};if(a=r.slice(1,17),[...a].map((e,t)=>`${[4,6,8,10].includes(t)?"-":""}${e.toString(16).padStart(2,"0")}`).join("")!==t)return{hasError:!0,message:"Unauthorized UUID"};var a;let n=18+r[17],o=!1,s=r[n];if(2===s)o=!0;else if(1!==s)return{hasError:!0,message:`command ${s} is not support`};let i=r[n+1]<<8|r[n+2],l=n+3,c=r[l++],d="";if(1===c)d=`${r[l++]}.${r[l++]}.${r[l++]}.${r[l++]}`;else if(2===c){let e=r[l++],t=[];for(let a=0;a<e;++a)t.push(r[l+a]);d=String.fromCharCode(...t),l+=e}else{if(3!==c)return{hasError:!0,message:`Invalid address type ${c}`};{let e=[];for(let t=0;t<8;++t){let t=r[l++],a=r[l++];e.push((t<<8|a).toString(16))}d=e.join(":")}}return{hasError:!1,addressRemote:d,portRemote:i,rawClientData:new Uint8Array(e,l),addressType:(e=>({1:1,2:3,3:4}[e]??null))(c),responseHeader:new Uint8Array([r[0],0]),isUDP:o}}function K(e,t){let r=new Uint8Array(e);if(r.length<64)return{hasError:!0,message:"Header too short"};if(String.fromCharCode(...r.slice(0,56))!==t)return{hasError:!0,message:"Unauthorized password"};if(13!==r[56]||10!==r[57])return{hasError:!0,message:"Missing CRLF after password hash"};let a=!1,n=58,o=r[n++];if(3==o)a=!0;else if(1!==o&&3!==o)return{hasError:!0,message:`Unknown CMD: ${o}`};let s=r[n++],i="";if(1===s){if(r.length<n+4+2)return{hasError:!0,message:"Header too short for IPv4"};i=`${r[n++]}.${r[n++]}.${r[n++]}.${r[n++]}`}else if(3===s){let e=r[n++];if(r.length<n+e+2)return{hasError:!0,message:"Header too short for domain"};i=String.fromCharCode(...r.slice(n,n+e)),n+=e}else{if(4!==s)return{hasError:!0,message:`Unknown addrType: ${s}`};{if(r.length<n+16+2)return{hasError:!0,message:"Header too short for IPv6"};let e=[];for(let t=0;t<8;++t){let t=r[n++]<<8|r[n++];e.push(t.toString(16))}i=e.join(":")}}return{hasError:!1,addressRemote:i,portRemote:r[n++]<<8|r[n++],rawClientData:new Uint8Array(e,n+2),addressType:s,responseHeader:null,isUDP:a}}function J(e){let t=new DataView(e),r=t.getUint8(0),a="",n=1,o=new TextDecoder;if(1===r)a=Array.from(new Uint8Array(e.slice(1,5))).join("."),n=5;else if(3===r){let r=t.getUint8(1);a=o.decode(e.slice(2,2+r)),n=2+r}else{if(4!==r)return{hasError:!0,message:`Invalid addressType: ${r}`};{let e=[];for(let r=0;r<8;r++)e.push(t.getUint16(1+2*r).toString(16));a=e.join(":"),n=17}}return{hasError:!1,addressRemote:a,portRemote:new DataView(e.slice(n,n+2)).getUint16(0),rawClientData:e.slice(n+2),addressType:r,responseHeader:null,isUDP:!1}}async function Q(e,t,r,a){let{addressType:n,addressRemote:o,portRemote:s,rawClientData:i,responseHeader:l}=t;async function c(t,r,o=!1){let s=o?await Z(n,t,r,a):W({hostname:t,port:r});a(`connected to ${t}:${r}`),e.value=s;let l=s.writable.getWriter();return await l.write(i),l.releaseLock(),s}let d=await c(o,s);C(d,r,l,async function(){if(k)d=await c(o,s,!0);else{let{address:e,port:t}=await X(o,s);d=await c(e,t)}d.closed.catch(e=>a("retry tcpSocket closed error",e)).finally(()=>A(r)),C(d,r,l,null,a)},a)}async function X(e,t,r=H){return r?.hostname?{address:r.hostname,port:r.port||t}:{address:await Y(e)||e,port:t}}async function Y(e,t=D){if("string"!=typeof e||!e.trim())return"";try{let r=await fetch(`https://dns.google.com/resolve?name=${e}&type=A`,{headers:{Accept:"application/dns-json"}});if(!r.ok)return"";let a=(await r.json()).Answer?.find(e=>1===e.type)?.data;if(!a)return"";let n=a.split(".");if(4!==n.length)return"";let o=n.map(e=>{let t=Number(e);return!Number.isInteger(t)||t<0||t>255?null:t.toString(16).padStart(2,"0")});return o.includes(null)?"":`[${t}${o[0]}${o[1]}:${o[2]}${o[3]}]`}catch{return""}}async function Z(e,t,r,a){let{username:n,password:o,hostname:s,port:i}=$,l=W({hostname:s,port:i}),c=new Uint8Array([5,2,0,2]),d=l.writable.getWriter();await d.write(c),a("sent socks greeting");let u,f=l.readable.getReader(),p=new TextEncoder,w=(await f.read()).value;if(5!==w[0])return void a(`socks server version error: ${w[0]} expected: 5`);if(255===w[1])return void a("no acceptable methods");if(2===w[1]){if(a("socks server needs auth"),!n||!o)return void a("please provide username/password");let e=new Uint8Array([1,n.length,...p.encode(n),o.length,...p.encode(o)]);if(await d.write(e),w=(await f.read()).value,1!==w[0]||0!==w[1])return void a("fail to auth socks server")}switch(e){case 1:u=new Uint8Array([1,...t.split(".").map(Number)]);break;case 3:u=new Uint8Array([3,t.length,...p.encode(t)]);break;case 4:u=new Uint8Array([4,...t.split(":").flatMap(e=>[parseInt(e.slice(0,2),16),parseInt(e.slice(2),16)])]);break;default:return void a(`invild  addressType is ${e}`)}let m=new Uint8Array([5,1,0,...u,r>>8,255&r]);if(await d.write(m),a("sent socks request"),w=(await f.read()).value,0===w[1])return a("socks connection opened"),d.releaseLock(),f.releaseLock(),l;a("fail to open socks connection")}async function C(e,t,r=null,a,n){let o=!1,s=!0,i=r instanceof Uint8Array?r:null,l=new WritableStream({write(e,r){if(t.readyState!==WebSocket.OPEN)return r.error("WebSocket not open");try{let r;s&&i?(r=new Uint8Array(i.length+e.length),r.set(i,0),r.set(e,i.length),s=!1,i=null):r=e,t.send(r),o=!0}catch(e){r.error("WritableStream error",e)}},abort(e){console.error("WritableStream aborted:",e)}});try{await e.readable.pipeTo(l)}catch(e){console.error("pipeTo error in remoteSocketToWS:",e),A(t)}!o&&"function"==typeof a&&a()}function ee(e){if(!e)return{earlyData:null,error:null};try{let t=e.replace(/-/g,"+").replace(/_/g,"/"),r=atob(t),a=r.length,n=new Uint8Array(a);for(let e=0;e<a;e++)n[e]=r.charCodeAt(e);return{earlyData:n.buffer,error:null}}catch(e){return{earlyData:null,error:e}}}function A(e,t=1e3,r="Normal Closure"){try{(e.readyState===WebSocket.OPEN||e.readyState===WebSocket.CONNECTING)&&e.close(t,r)}catch(e){console.error("Failed close WebSocket",e)}}async function te(e,t,r){let a=!1,n=new TransformStream({start(e){},transform(e,t){for(let r=0;r<e.byteLength;){let a=e.slice(r,r+2),n=new DataView(a).getUint16(0),o=new Uint8Array(e.slice(r+2,r+2+n));r=r+2+n,t.enqueue(o)}},flush(e){}});n.readable.pipeTo(new WritableStream({async write(n){let o=await(await fetch("https://1.1.1.1/dns-query",{method:"POST",headers:{"content-type":"application/dns-message"},body:n})).arrayBuffer(),s=o.byteLength,i=new Uint8Array([s>>8&255,255&s]);e.readyState===WebSocket.OPEN&&(r(`doh success and dns message length is ${s}`),a?e.send(await new Blob([i,o]).arrayBuffer()):(e.send(await new Blob([t,i,o]).arrayBuffer()),a=!0))}})).catch(e=>r("dns udp has error"+e));let o=n.writable.getWriter();return{write(e){o.write(e)}}}function re(e){let t=new Uint8Array(e);if(t.byteLength>=17){let e=(240&t[7])>>4;if(128==(192&t[9])&&(4===e||7===e))return 1}if(t.byteLength>=62){let[e,r,a,n]=[t[56],t[57],t[58],t[59]],o=[1,3,4];if(13===e&&10===r&&[1,3,127].includes(a)&&o.includes(n))return 2}return t.byteLength>10&&[1,3,4].includes(t[0])?0:3}export{ce as default};